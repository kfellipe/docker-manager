{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Docker Manager - Gerenciador de Containers</title>
    <link rel="shortcut icon" href="{% static 'favicon.png' %}" type="image/x-icon">
    <link rel="stylesheet" href="{% static 'style.css' %}">
</head>
<body>
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo" onclick="showPage('dashboard')">
                    Docker Manager
                </div>
                <nav class="nav-links">
                    <a class="nav-link" id="dashboard-link" onclick="showPage('dashboard')">Dashboard</a>
                    <a class="nav-link" id="create-link" onclick="showPage('create')">Criar Containers</a>
                </nav>
                <button class="theme-toggle" id="themeToggle">
                    <span id="themeIcon">üåô</span>
                    <span id="themeText">Tema Escuro</span>
                </button>
            </div>
        </div>
    </header>

    <main class="main">
        <div class="container">
            <!-- Dashboard Page -->
            <section id="dashboard-page" class="page-section active">
                <h1 class="page-title">Gerenciador de Containers</h1>
                <p class="page-subtitle">Monitore e gerencie seus containers Docker em tempo real</p>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value stat-running">3</div>
                        <div class="stat-label">Containers Rodando</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value stat-stopped">2</div>
                        <div class="stat-label">Containers Parados</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value stat-total">5</div>
                        <div class="stat-label">Total de Containers</div>
                    </div>
                </div>

                <div class="table-container">
                    <div class="table-header">
                        <h2 class="table-title">Containers Ativos</h2>
                        <button class="refresh-btn" onclick="refreshContainers()">
                            üîÑ Atualizar
                        </button>
                    </div>
                    <form id="bulkActionsForm" action="{% url 'view_docker_containers' %}" method="post">
                        {% csrf_token %}
                        <div class="bulk-actions">
                            <div class="selection-info">
                                <span id="selectedCount">0</span> containers selecionados
                            </div>
                            <div class="bulk-buttons">
                                <button type="button" class="bulk-btn bulk-btn-start" id="bulkStartBtn" onclick="bulkStartContainers()" disabled>
                                    ‚ñ∂Ô∏è Iniciar
                                </button>
                                <button type="button" class="bulk-btn bulk-btn-stop" id="bulkStopBtn" onclick="bulkStopContainers()" disabled>
                                    ‚èπÔ∏è Parar
                                </button>
                                <button type="button" class="bulk-btn bulk-btn-restart" id="bulkRestartBtn" onclick="bulkRestartContainers()" disabled>
                                    üîÑ Reiniciar
                                </button>
                                <button type="button" class="bulk-btn bulk-btn-delete" id="bulkDeleteBtn" onclick="bulkDeleteContainers()" disabled>
                                    üóëÔ∏è Remover
                                </button>
                            </div>
                        </div>

                        <table class="table">
                            <thead>
                                <tr>
                                    <th class="checkbox-cell">
                                        <input type="checkbox" id="selectAll" class="container-checkbox" onchange="toggleSelectAll()">
                                    </th>
                                    <th>Nome</th>
                                    <th>Image</th>
                                    <th>Status</th>
                                    <th>Portas</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for container in containers %}
                                <tr>
                                    <td class="checkbox-cell">
                                        <input type="checkbox" data-container-id="database" class="container-checkbox" name="container_names" value="{{ container.nome }}" onchange="updateSelection()">
                                    </td>
                                    <td class="container-name">{{ container.nome }}</td>
                                    <td>{{ container.imagem.0 }}</td>
                                    <td>
                                        <span class="status-badge {% if container.status == 'running' %}status-running{% else %}status-stopped{% endif %}">
                                            {{ container.status|capfirst }}
                                        </span>
                                    </td>
                                    <td class="ports">
                                        {% for porta in container.ports %}
                                        {{ porta }}<br>
                                        {% endfor %}
                                        {% if not container.ports %}
                                        Nenhuma porta mapeada
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </form>
                </div>
            </section>

            <!-- Create Containers Page -->
            <section id="create-page" class="page-section">
                <div class="create-container">
                    <div class="page-header">
                        <h1 class="page-title">Criar Containers em Massa</h1>
                        <p class="page-subtitle">Configure e crie m√∫ltiplos containers de uma s√≥ vez</p>
                    </div>

                    <div class="form-card">
                        <form id="createContainersForm">
                            <div class="form-group">
                                <label for="containerCount" class="form-label">
                                    üìä Quantidade de Containers
                                </label>
                                <input 
                                    type="number" 
                                    id="containerCount" 
                                    class="form-input" 
                                    min="1" 
                                    max="50" 
                                    value="1" 
                                    placeholder="Digite a quantidade (1-50)"
                                    required
                                >
                            </div>

                            <div class="form-group">
                                <label class="form-label">
                                    üê≥ Tipo de Container
                                </label>
                                <div class="container-types">
                                    <div class="container-type" data-type="nginx">
                                        <div class="container-type-icon">üåê</div>
                                        <div class="container-type-name">Web Server</div>
                                        <div class="container-type-desc">Nginx</div>
                                    </div>
                                    <div class="container-type" data-type="mysql">
                                        <div class="container-type-icon">üóÑÔ∏è</div>
                                        <div class="container-type-name">MySQL</div>
                                        <div class="container-type-desc">Database</div>
                                    </div>
                                    <div class="container-type" data-type="postgres">
                                        <div class="container-type-icon">üêò</div>
                                        <div class="container-type-name">PostgreSQL</div>
                                        <div class="container-type-desc">Database</div>
                                    </div>
                                    <div class="container-type" data-type="redis">
                                        <div class="container-type-icon">‚ö°</div>
                                        <div class="container-type-name">Redis</div>
                                        <div class="container-type-desc">Cache</div>
                                    </div>
                                    <div class="container-type" data-type="ssh">
                                        <div class="container-type-icon">üîê</div>
                                        <div class="container-type-name">SSH Server</div>
                                        <div class="container-type-desc">OpenSSH</div>
                                    </div>
                                    <div class="container-type" data-type="node">
                                        <div class="container-type-icon">üíö</div>
                                        <div class="container-type-name">Node.js</div>
                                        <div class="container-type-desc">Runtime</div>
                                    </div>
                                    <div class="container-type" data-type="python">
                                        <div class="container-type-icon">üêç</div>
                                        <div class="container-type-name">Python</div>
                                        <div class="container-type-desc">Runtime</div>
                                    </div>
                                    <div class="container-type" data-type="apache">
                                        <div class="container-type-icon">ü™∂</div>
                                        <div class="container-type-name">Apache</div>
                                        <div class="container-type-desc">Web Server</div>
                                    </div>
                                </div>
                            </div>

                            <div class="form-actions">
                                <button type="button" class="btn btn-secondary" onclick="resetForm()">
                                    üîÑ Limpar
                                </button>
                                <button type="submit" class="btn btn-primary" id="createBtn">
                                    üöÄ Criar Containers
                                </button>
                            </div>

                            <div class="progress-container" id="progressContainer">
                                <div class="progress-bar">
                                    <div class="progress-fill" id="progressFill"></div>
                                </div>
                                <div class="progress-text" id="progressText">
                                    Criando containers...
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </section>
        </div>
    </main>
    <!-- Modal de Confirma√ß√£o -->
    <div id="confirmModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.4); z-index:9999; align-items:center; justify-content:center;">
        <div style="background:white; padding:2rem; border-radius:8px; max-width:90vw; min-width:300px; text-align:center; box-shadow:0 8px 32px rgba(0,0,0,0.2);">
            <p id="confirmModalText" style="margin-bottom:2rem; color:#1e293b; font-size:1.1rem;"></p>
            <button id="confirmModalYes" class="btn btn-primary" style="min-width:100px; margin-right:1rem;">Confirmar</button>
            <button id="confirmModalNo" class="btn btn-secondary" style="min-width:100px;">Cancelar</button>
        </div>
    </div>
    <div id="toastContainer" style="position:fixed; bottom:24px; left:24px; z-index:10000; display:flex; flex-direction:column; gap:12px;"></div>
    <script>

        // Page Navigation
        function showPage(pageId) {
            // Hide all pages
            document.querySelectorAll('.page-section').forEach(page => {
                page.classList.remove('active');
            });
            
            // Show selected page
            document.getElementById(`${pageId}-page`).classList.add('active');
            
            // Update navigation links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            document.getElementById(`${pageId}-link`).classList.add('active');
        }

        // Theme Toggle Functionality
        const themeToggle = document.getElementById('themeToggle');
        const themeIcon = document.getElementById('themeIcon');
        const themeText = document.getElementById('themeText');
        const body = document.body;

        // Check for saved theme preference or default to light mode
        const currentTheme = localStorage.getItem('theme') || 'light';
        body.setAttribute('data-theme', currentTheme);
        updateThemeButton(currentTheme);

        themeToggle.addEventListener('click', () => {
            const currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeButton(newTheme);
        });

        function updateThemeButton(theme) {
            if (theme === 'dark') {
                themeIcon.textContent = '‚òÄÔ∏è';
                themeText.textContent = 'Tema Claro';
            } else {
                themeIcon.textContent = 'üåô';
                themeText.textContent = 'Tema Escuro';
            }
        }

        // Container Selection Management
        function getSelectedContainers() {
            const checkboxes = document.querySelectorAll('.container-checkbox[data-container-id]');
            const selected = [];
            
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    selected.push(checkbox.dataset.containerId);
                }
            });
            
            return selected;
        }

        function updateSelection() {
            const selectedContainers = getSelectedContainers();
            const selectedCount = selectedContainers.length;
            
            // Update selection count
            document.getElementById('selectedCount').textContent = selectedCount;
            
            // Enable/disable bulk action buttons
            const bulkButtons = document.querySelectorAll('.bulk-btn');
            bulkButtons.forEach(btn => {
                btn.disabled = selectedCount === 0;
            });
            
            // Update select all checkbox
            const allCheckboxes = document.querySelectorAll('.container-checkbox[data-container-id]');
            const selectAllCheckbox = document.getElementById('selectAll');
            
            if (selectedCount === 0) {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = false;
            } else if (selectedCount === allCheckboxes.length) {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = true;
            } else {
                selectAllCheckbox.indeterminate = true;
            }
            
            // Update row highlighting
            allCheckboxes.forEach(checkbox => {
                const row = checkbox.closest('tr');
                if (checkbox.checked) {
                    row.classList.add('selected');
                } else {
                    row.classList.remove('selected');
                }
            });
        }

        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAll');
            const containerCheckboxes = document.querySelectorAll('.container-checkbox[data-container-id]');
            
            containerCheckboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
            
            updateSelection();
        }

        // Bulk Actions
        function bulkStartContainers() {
            const selectedContainers = getSelectedContainers();
            if (selectedContainers.length === 0) {
                alert('Selecione pelo menos um container!');
                return;
            }
            showConfirmModal("Tem certeza que deseja iniciar os containers selecionados?", function () {
                hiddenInputStart = document.createElement('input');
                hiddenInputStart.type = 'hidden';
                hiddenInputStart.name = 'action';
                hiddenInputStart.value = 'start';
                let formBulk = document.getElementById('bulkActionsForm')
                formBulk.appendChild(hiddenInputStart);
                formBulk.submit();

            })
        
        }

        function bulkStopContainers() {
            const selectedContainers = getSelectedContainers();
            if (selectedContainers.length === 0) {
                alert('Selecione pelo menos um container!');
                return;
            }
            showConfirmModal("Tem certeza que deseja parar os containers selecionados?", function () {
                hiddenInputStart = document.createElement('input');
                hiddenInputStart.type = 'hidden';
                hiddenInputStart.name = 'action';
                hiddenInputStart.value = 'stop';
                let formBulk = document.getElementById('bulkActionsForm')
                formBulk.appendChild(hiddenInputStart);
                formBulk.submit();
            })
        }

        function bulkRestartContainers() {
            const selectedContainers = getSelectedContainers();
            if (selectedContainers.length === 0) {
                alert('Selecione pelo menos um container!');
                return;
            }
            
            console.log('Reiniciando containers:', selectedContainers);
            alert(`Reiniciando ${selectedContainers.length} containers: ${selectedContainers.join(', ')}`);
            
            // Aqui voc√™ enviaria os IDs para a API
            // fetch('/api/containers/restart', {
            //     method: 'POST',
            //     headers: { 'Content-Type': 'application/json' },
            //     body: JSON.stringify({ containerIds: selectedContainers })
            // });
        }

        function bulkDeleteContainers() {
            const selectedContainers = getSelectedContainers();
            if (selectedContainers.length === 0) {
                alert('Selecione pelo menos um container!');
                return;
            }
            
            if (confirm(`Tem certeza que deseja remover ${selectedContainers.length} containers?\n\nContainers: ${selectedContainers.join(', ')}`)) {
                console.log('Removendo containers:', selectedContainers);
                alert(`${selectedContainers.length} containers removidos com sucesso!`);
                
                // Aqui voc√™ enviaria os IDs para a API
                // fetch('/api/containers/delete', {
                //     method: 'DELETE',
                //     headers: { 'Content-Type': 'application/json' },
                //     body: JSON.stringify({ containerIds: selectedContainers })
                // });
            }
        }

        function refreshContainers() {
            console.log('Atualizando lista de containers...');
            alert('Atualizando lista de containers...');
            // Aqui voc√™ faria uma nova requisi√ß√£o para buscar os containers atualizados
        }

        // Container Type Selection
        const containerTypes = document.querySelectorAll('.container-type');
        let selectedType = null;

        containerTypes.forEach(type => {
            type.addEventListener('click', () => {
                // Remove selection from all types
                containerTypes.forEach(t => t.classList.remove('selected'));
                
                // Add selection to clicked type
                type.classList.add('selected');
                selectedType = type.dataset.type;
                
                console.log('Selected container type:', selectedType);
            });
        });

        // Form Submission
        const form = document.getElementById('createContainersForm');
        const createBtn = document.getElementById('createBtn');
        const progressContainer = document.getElementById('progressContainer');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const containerCount = document.getElementById('containerCount').value;
            
            if (!selectedType) {
                alert('Por favor, selecione um tipo de container!');
                return;
            }

            if (containerCount < 1 || containerCount > 50) {
                alert('A quantidade deve estar entre 1 e 50 containers!');
                return;
            }

            await createContainers(containerCount, selectedType);
        });

        async function createContainers(count, type) {
            // Disable form
            createBtn.disabled = true;
            createBtn.innerHTML = '‚è≥ Criando...';
            progressContainer.style.display = 'block';

            const containerConfigs = {
                nginx: { image: 'nginx:latest', ports: '80' },
                mysql: { image: 'mysql:8.0', ports: '3306' },
                postgres: { image: 'postgres:13', ports: '5432' },
                redis: { image: 'redis:alpine', ports: '6379' },
                ssh: { image: 'linuxserver/openssh-server', ports: '2222' },
                node: { image: 'node:16-alpine', ports: '3000' },
                python: { image: 'python:3.9-slim', ports: '8000' },
                apache: { image: 'httpd:latest', ports: '80' }
            };

            const config = containerConfigs[type];
            
            try {
                const containerIds = [];
                
                for (let i = 1; i <= count; i++) {
                    // Simulate container creation
                    const progress = (i / count) * 100;
                    progressFill.style.width = `${progress}%`;
                    progressText.textContent = `Criando container ${i} de ${count}...`;
                    
                    // Simulate API call delay
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    const containerId = `${type}-${Date.now()}-${i}`;
                    containerIds.push(containerId);
                    
                    console.log(`Container ${i} criado:`, {
                        id: containerId,
                        name: `${type}-${i}`,
                        image: config.image,
                        ports: config.ports
                    });
                }

                // Success
                progressText.textContent = `‚úÖ ${count} containers criados com sucesso!`;
                progressFill.style.backgroundColor = 'var(--success-color)';
                
                console.log('IDs dos containers criados:', containerIds);
                
                setTimeout(() => {
                    alert(`${count} containers do tipo "${type}" foram criados com sucesso!\n\nIDs: ${containerIds.join(', ')}`);
                    resetForm();
                    showPage('dashboard'); // Redirect to dashboard after creation
                }, 1000);

            } catch (error) {
                console.error('Erro ao criar containers:', error);
                progressText.textContent = '‚ùå Erro ao criar containers';
                progressFill.style.backgroundColor = 'var(--danger-color)';
                alert('Erro ao criar containers. Tente novamente.');
            } finally {
                // Re-enable form
                setTimeout(() => {
                    createBtn.disabled = false;
                    createBtn.innerHTML = 'üöÄ Criar Containers';
                    progressContainer.style.display = 'none';
                    progressFill.style.backgroundColor = 'var(--accent-color)';
                    progressFill.style.width = '0%';
                }, 2000);
            }
        }

        function resetForm() {
            document.getElementById('containerCount').value = '1';
            containerTypes.forEach(t => t.classList.remove('selected'));
            selectedType = null;
            progressContainer.style.display = 'none';
            progressFill.style.width = '0%';
        }

        // Input validation
        const containerCountInput = document.getElementById('containerCount');
        containerCountInput.addEventListener('input', (e) => {
            const value = parseInt(e.target.value);
            if (value > 50) {
                e.target.value = 50;
                alert('M√°ximo de 50 containers permitidos por vez!');
            } else if (value < 1) {
                e.target.value = 1;
            }
        });

        // Initialize navigation and selection
        document.getElementById('dashboard-link').classList.add('active');
        updateSelection();

        document.querySelectorAll('.table tbody tr').forEach(row => {
            row.addEventListener('click', function(e) {
                // Evita conflito se clicar diretamente no checkbox
                if (e.target.type === 'checkbox') return;
                const checkbox = this.querySelector('.container-checkbox[data-container-id]');
                if (checkbox) {
                    checkbox.checked = !checkbox.checked;
                    updateSelection();
                }
            });
        });

        function showToast(message, type='success', duration=4000) {
            const toastContainer = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.style.padding = '1rem 1.5rem';
            toast.style.borderRadius = '8px';
            toast.style.boxShadow = '0 4px 16px rgba(0,0,0,0.08)';
            toast.style.color = '#fff';
            toast.style.fontWeight = '500';
            toast.style.fontSize = '1rem';
            toast.style.background = type === 'success' ? 'var(--success-color, #10b981)' : 'var(--danger-color, #ef4444)';
            toast.style.opacity = '0.95';
            toast.style.transition = 'opacity 0.3s';

            toastContainer.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        function showConfirmModal(message, onConfirm) {
            document.getElementById('confirmModalText').textContent = message;
            document.getElementById('confirmModal').style.display = 'flex';

            const yesBtn = document.getElementById('confirmModalYes');
            const noBtn = document.getElementById('confirmModalNo');

            function cleanup() {
                document.getElementById('confirmModal').style.display = 'none';
                yesBtn.removeEventListener('click', onYes);
                noBtn.removeEventListener('click', onNo);
            }

            function onYes() {
                cleanup();
                if (typeof onConfirm === 'function') onConfirm();
            }
            function onNo() {
                cleanup();
            }

            yesBtn.addEventListener('click', onYes);
            noBtn.addEventListener('click', onNo);
        }

        {% if message %}
        showToast("{{ message }}", "{{ status }}");
        {% endif %}
    </script>
</body>
</html>